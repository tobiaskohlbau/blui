on:
  workflow_run:
    workflows: [Test]
    types: [completed]
    branches: [main]

  workflow_dispatch: {}

name: Release

permissions:
  contents: write

jobs:
  tag:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      - name: Tag Tip
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git tag -f tip ${GITHUB_SHA}
          git push --force origin tip

  build-and-upload:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-linux
            artifact_name: blUI-linux-x86_64
          - os: ubuntu-latest
            target: aarch64-linux
            artifact_name: blUI-linux-aarch64
          - os: macos-latest
            target: x86_64-macos
            artifact_name: blUI-macos-x86_64
          - os: macos-latest
            target: aarch64-macos
            artifact_name: blUI-macos-aarch64
          - os: windows-latest
            target: x86_64-windows
            artifact_name: blUI-windows-x86_64.exe
          - os: windows-latest
            target: aarch64-windows
            artifact_name: blUI-windows-aarch64.exe
    runs-on: ${{ matrix.os }}
    needs: [tag]
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup build environment (Linux/macOS)
        if: runner.os != 'Windows'
        uses: cachix/install-nix-action@4e002c8ec80594ecd40e759629461e26c8abed15 # v31.9.0
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Install zig (Windows)
        if: runner.os == 'Windows'
        uses: mlugg/setup-zig@e7d1537c378b83b8049f65dda471d87a2f7b2df2  # v2.2.0

      - name: Install pnpm (Windows)
        if: runner.os == 'Windows'
        uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
        with:
          version: 10

      - name: Install Node.js (Windows)
        if: runner.os == 'Windows'
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: 'lts/*'

      - name: Build binary (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          nix develop -c zig build -Dtarget=${{ matrix.target }} -Doptimize=ReleaseSafe
          cp zig-out/bin/blUI ${{ matrix.artifact_name }}

      - name: Build binary (Windows)
        if: runner.os == 'Windows'
        run: |
          zig build -Dtarget=${{ matrix.target }} -Doptimize=ReleaseSafe
          cp zig-out/bin/blUI.exe ${{ matrix.artifact_name }}

      - name: Install minisign
        run: |
          if [ "$RUNNER_OS" = "Linux" ]; then
            sudo apt-get update && sudo apt-get install -y minisign
          elif [ "$RUNNER_OS" = "macOS" ]; then
            brew install minisign
          elif [ "$RUNNER_OS" = "Windows" ]; then
            choco install minisign -y
          fi
        shell: bash

      - name: Sign binary
        env:
          MINISIGN_KEY: ${{ secrets.MINISIGN_KEY }}
          MINISIGN_PASSWORD: ${{ secrets.MINISIGN_PASSWORD }}
        run: |
          echo "$MINISIGN_KEY" > minisign.key
          echo "$MINISIGN_PASSWORD" | minisign -S -s minisign.key -m ${{ matrix.artifact_name }} -x ${{ matrix.artifact_name }}.minisig
          rm minisign.key
        shell: bash

      - name: Upload Release Asset
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          name: 'blUI Nightly'
          prerelease: true
          tag_name: tip
          target_commitish: ${{ github.sha }}
          files: ./${{ matrix.artifact_name }}

      - name: Upload Signature
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          name: 'blUI Nightly'
          prerelease: true
          tag_name: tip
          target_commitish: ${{ github.sha }}
          files: ./${{ matrix.artifact_name }}.minisig

      - name: Generate checksums
        run: |
          sha256sum ${{ matrix.artifact_name }} > ${{ matrix.artifact_name }}.sha256
        shell: bash

      - name: Upload Checksum
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          name: 'blUI Nightly'
          prerelease: true
          tag_name: tip
          target_commitish: ${{ github.sha }}
          files: ./${{ matrix.artifact_name }}.sha256
